<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GIBBSTA – Favoriten</title>

  <link rel="stylesheet" href="home-styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL="https://sdmlprsgxgrnzoqvgyqz.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWxwcnNneGdybnpvcXZneXF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDMyMDk4NiwiZXhwIjoyMDc1ODk2OTg2fQ.rWp3zL2V37X76_PdQAq-pw4uSzpOIyeQ9l3bjEC7tCM";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    function publicUrl(path){ return sb.storage.from('images').getPublicUrl(path).data.publicUrl; }
  </script>

  <style>
    body{background:#fafafa;margin:0}
    .top-nav{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;border-bottom:1px solid #dbdbdb;display:flex;align-items:center;justify-content:center;z-index:100}
    .nav-logo{height:40px}
    .tabs{display:flex;gap:10px;margin:80px auto 10px;max-width:900px;padding:0 16px}
    .tab{border:1px solid #dbdbdb;border-radius:20px;padding:8px 14px;background:#fff;cursor:pointer}
    .tab.active{background:#0095f6;color:#fff;border-color:#0095f6}
    .grid{max-width:900px;margin:0 auto 100px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;padding:0 16px}
    .tile{position:relative;border:1px solid #dbdbdb;border-radius:8px;overflow:hidden;background:#fff;cursor:pointer}
    .tile img{width:100%;height:180px;object-fit:cover;display:block}
    .tile .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;font-size:14px}
    .empty{max-width:900px;margin:40px auto;text-align:center;color:#8e8e8e}
    .muted{color:#8e8e8e}
    .meta{display:flex;gap:8px;align-items:center}
    .meta .user{font-weight:600}
    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #dbdbdb;padding:16px 0;z-index:100}
    .nav-container{max-width:500px;margin:0 auto;display:flex;justify-content:space-around;align-items:center}
    .nav-item{background:none;border:none;cursor:pointer;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:50%}
    .nav-item.plus-btn{width:35px;height:35px;border:2px solid #262626;border-radius:4px}
    .nav-item svg{width:24px;height:24px;color:#262626}
  </style>
</head>
<body>

  <header class="top-nav">
    <img class="nav-logo" src="https://i.ibb.co/Q7mG5wr3/Gibbsta-Logo-Haupt.png" alt="Gibbsta">
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="liked">Geliked</button>
    <button class="tab" data-tab="saved">Gespeichert</button>
  </div>

  <section class="grid" id="grid"></section>
  <p class="empty" id="empty" style="display:none">Hier ist noch nichts. Like oder speichere Beiträge.</p>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-container">
      <button class="nav-item" onclick="location.href='home.html'">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='search.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="nav-item plus-btn" onclick="location.href='post.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='homepage.html'">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M12 14c-4.5 0-8 2.5-8 5v1h16v-1c0-2.5-3.5-5-8-5z"></path>
        </svg>
      </button>
    </div>
  </nav>

  <script>
    let CU=null, active='liked';

    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        active=b.dataset.tab;
        render();
      };
    });

    async function idsFromDB(){
      if(!CU) return [];
      if(active==='liked'){
        const { data, error } = await sb.from('post_likes')
          .select('post_id, created_at')
          .eq('user_id', CU.id)
          .order('created_at', { ascending:false });
        if(error){ console.warn(error); return []; }
        return (data||[]).map(r=>r.post_id);
      }else{
        const { data, error } = await sb.from('post_saves')
          .select('post_id, created_at')
          .eq('user_id', CU.id)
          .order('created_at', { ascending:false });
        if(error){ console.warn(error); return []; }
        return (data||[]).map(r=>r.post_id);
      }
    }

    async function fetchPostsByIds(ids){
      if(!ids.length) return [];
      const { data, error } = await sb.from('posts')
        .select('id, image_path, caption, user_id')
        .in('id', ids);
      if(error){ console.warn(error); return []; }
      const map = Object.fromEntries((data||[]).map(p=>[String(p.id), p]));
      // gleiche Reihenfolge wie ids
      return ids.map(id=>map[String(id)]).filter(Boolean);
    }

    function openPost(id){ location.href='post.html?id='+encodeURIComponent(id); }

    async function render(){
      const grid = document.getElementById('grid');
      const emptyEl = document.getElementById('empty');
      grid.innerHTML='';

      const ids = await idsFromDB();
      if(!ids.length){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      const posts = await fetchPostsByIds(ids);
      if(!posts.length){ emptyEl.style.display='block'; return; }

      posts.forEach(p=>{
        const img = publicUrl(p.image_path);
        grid.insertAdjacentHTML('beforeend', `
          <div class="tile" onclick="openPost('${p.id}')">
            <img src="${img}" alt="">
            <div class="bar">
              <span>${active==='liked' ? 'Geliked' : 'Gespeichert'}</span>
              <span class="muted">#${p.id}</span>
            </div>
          </div>
        `);
      });
    }

    (async function init(){
      const { data: auth } = await sb.auth.getUser();
      CU = auth?.user;
      if(!CU){ location.href='index.html'; return; }
      await render();

      // Realtime: bei Änderungen automatisch neu rendern
      try{
        sb.channel('fav_likes_'+CU.id)
          .on('postgres_changes', {event:'*', schema:'public', table:'post_likes', filter:`user_id=eq.${CU.id}`}, ()=>{ if(active==='liked') render(); })
          .subscribe();
        sb.channel('fav_saves_'+CU.id)
          .on('postgres_changes', {event:'*', schema:'public', table:'post_saves', filter:`user_id=eq.${CU.id}`}, ()=>{ if(active==='saved') render(); })
          .subscribe();
      }catch(e){ console.warn('Realtime Favoriten nicht aktiv?', e); }
    })();
  </script>
</body>
</html>

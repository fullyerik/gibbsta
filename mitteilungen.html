<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gibbsta – Mitteilungen</title>

  <link rel="stylesheet" href="home-styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL="https://sdmlprsgxgrnzoqvgyqz.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWxwcnNneGdybnpvcXZneXF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDMyMDk4NiwiZXhwIjoyMDc1ODk2OTg2fQ.rWp3zL2V37X76_PdQAq-pw4uSzpOIyeQ9l3bjEC7tCM";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    function publicUrl(path){ return sb.storage.from('images').getPublicUrl(path).data.publicUrl; }
  </script>

  <style>
    :root{
      --card:#fff;
      --muted:#8e8e8e;
      --border:#dbdbdb;
      --brand:#0095f6;
      --bg:#fafafa;
      --unread:#f6f8ff;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#262626;margin:0}
    .wrap{max-width:720px;margin:80px auto 110px;padding:0 16px}
    .top-nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;z-index:50}
    .top-nav .back-btn{position:absolute;left:10px;top:10px}
    .top-nav .centered{display:block;margin:0 auto;height:32px}
    .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .controls h2{margin:0;font-size:20px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    #list{display:flex;flex-direction:column;gap:8px}
    .notif{display:grid;grid-template-columns:54px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;background:var(--card);padding:10px}
    .notif.unread{background:var(--unread)}
    .ava{width:54px;height:54px;border-radius:10px;object-fit:cover;border:1px solid #ddd}
    .meta{display:flex;flex-direction:column;gap:4px;min-width:0}
    .line{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px}
    .alink{all:unset;color:#262626;cursor:pointer}
    .alink:hover{text-decoration:underline}
    .empty{text-align:center;color:var(--muted);margin-top:20px}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="top-nav">
    <button onclick="history.back()" class="btn back-btn" title="Zurück">←</button>
    <img class="nav-logo centered" src="https://i.ibb.co/Q7mG5wr3/Gibbsta-Logo-Haupt.png" alt="Gibbsta">
  </header>

  <main class="wrap">
    <div class="controls">
      <h2>Mitteilungen</h2>
      <div class="actions">
        <button id="markAllBtn" class="btn primary">Alle als gelesen</button>
        <button id="clearAllBtn" class="btn danger">Alles löschen</button>
      </div>
    </div>

    <section id="list"></section>
    <p id="empty" class="empty" style="display:none">Noch keine Mitteilungen.</p>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-container">
      <button class="nav-item" onclick="location.href='home.html'">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='search.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="nav-item plus-btn" onclick="location.href='post.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='homepage.html'">
        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="8" r="4"/><path d="M12 14c-4.5 0-8 2.5-8 5v1h16v-1c0-2.5-3.5-5-8-5z"/></svg>
      </button>
    </div>
  </nav>

  <script>
    let CU = null; // current user
    const fmt = new Intl.DateTimeFormat('de-CH', { dateStyle:'medium', timeStyle:'short' });

    // Minimal Notif-API (kompatibel mit deiner DB-Struktur)
    const notif = {
      async listForUser(uid){
        const { data, error } = await sb
          .from('notifications')
          .select('id, owner_id, from_user_id, type, post_id, comment, read, created_at')
          .eq('owner_id', uid)
          .order('created_at', { ascending:false });
        if(error){ console.error(error); return []; }
        return data || [];
      },
      async markAllRead(uid){
        const { error } = await sb.from('notifications').update({ read: true }).eq('owner_id', uid);
        if(error) console.error(error);
      },
      async clearAll(uid){
        const { error } = await sb.from('notifications').delete().eq('owner_id', uid);
        if(error) console.error(error);
      }
    };

    function isUUID(v){
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(v||"").trim());
    }

    async function fetchProfilesMap(userIds){
      if(!userIds || !userIds.length) return { byId:{}, fallback:'https://via.placeholder.com/48/dbdbdb/262626?text=+' };
      const ids=[...new Set(userIds.filter(Boolean))];
      const { data, error } = await sb.from('profiles').select('id, username, avatar_url, avatar_path').in('id', ids);
      if(error){ console.warn('profiles', error); }
      const map={};
      for(const p of (data||[])){
        const avatar = p.avatar_url || (p.avatar_path ? publicUrl(p.avatar_path) : '');
        map[p.id] = {
          username: p.username || (p.id ? p.id.slice(0,8) : 'user'),
          avatar: avatar || 'https://via.placeholder.com/54/dbdbdb/262626?text=+'
        };
      }
      return { byId: map, fallback: 'https://via.placeholder.com/54/dbdbdb/262626?text=+' };
    }

    function iconFor(type){
      if(type==='comment') return '<i class="fa-regular fa-comment"></i>';
      if(type==='like') return '<i class="fa-regular fa-heart"></i>';
      if(type==='follow') return '<i class="fa-solid fa-user-plus"></i>';
      return '<i class="fa-regular fa-bell"></i>';
    }
    function textFor(n, prof){
      const uname = prof?.username ? '@'+prof.username : 'Jemand';
      switch(n.type){
        case 'comment': return `${uname} hat deinen Beitrag kommentiert: "${n.comment || ''}"`;
        case 'like':    return `${uname} gefällt dein Beitrag`;
        case 'follow':  return `${uname} folgt dir jetzt`;
        default:        return `${uname} hat eine Aktion ausgeführt`;
      }
    }

    function timeAgo(ts){
      const d = new Date(ts);
      const diff = Date.now() - d.getTime();
      const sec = Math.floor(diff/1000);
      if (sec < 60) return 'gerade eben';
      const min = Math.floor(sec/60);
      if (min < 60) return `${min} min`;
      const hr = Math.floor(min/60);
      if (hr < 24) return `${hr} h`;
      const day = Math.floor(hr/24);
      if (day < 7) return `${day} Tage`;
      return fmt.format(d);
    }

    function notifItem(n, prof){
      const avatar = prof?.avatar || 'https://via.placeholder.com/54/dbdbdb/262626?text=+';
      const uname  = prof?.username || (n.from_user_id ? n.from_user_id.slice(0,8) : 'user');
      const userHref = `profile.html?uid=${encodeURIComponent(n.from_user_id)}`;
      const postHref = n.post_id != null ? `post.html?id=${encodeURIComponent(n.post_id)}` : null;

      return `
      <article class="notif ${!n.read ? 'unread':''}" data-id="${n.id}">
        <img class="ava" src="${avatar}" alt="@${uname}" onerror="this.src='https://via.placeholder.com/54/dbdbdb/262626?text=+'"/>
        <div class="meta">
          <div class="line">${iconFor(n.type)} <a class="alink" href="${userHref}">@${uname}</a> <span> ${textFor(n, prof).replace('@'+uname,'').trim()}</span> ${postHref ? ` – <a class="alink" href="${postHref}">Zum Beitrag</a>` : ``}</div>
          <div class="time">${timeAgo(n.created_at)}</div>
        </div>
        <div>
          <!-- optional single delete later -->
        </div>
      </article>`;
    }

    async function render(){
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      list.innerHTML = '<div class="empty">Lade…</div>';

      const rows = await notif.listForUser(CU.id);
      if(!rows.length){
        list.innerHTML='';
        empty.style.display='block';
        return;
      }
      empty.style.display='none';

      const uids = rows.map(r=>r.from_user_id).filter(Boolean);
      const profs = await fetchProfilesMap(uids);

      list.innerHTML = rows.map(r => notifItem(r, profs.byId[r.from_user_id])).join('');
    }

    async function init(){
      const u = (await sb.auth.getUser()).data.user;
      if(!u){ location.href='index.html'; return; }
      CU = u;

      // Buttons
      document.getElementById('markAllBtn').onclick = async ()=>{
        await notif.markAllRead(CU.id);
        await render();
      };
      document.getElementById('clearAllBtn').onclick = async ()=>{
        if(confirm('Wirklich alle Mitteilungen löschen?')){
          await notif.clearAll(CU.id);
          await render();
        }
      };

      await render();

      // Realtime (optional – aktualisiert Liste bei neuen Einträgen)
      try{
        sb.channel('notifications_'+CU.id)
          .on('postgres_changes', {event:'*', schema:'public', table:'notifications', filter:`owner_id=eq.${CU.id}`}, render)
          .subscribe();
      }catch(e){ console.warn('Realtime nicht aktiv?', e); }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

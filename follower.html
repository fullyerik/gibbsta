<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Follower – GIBBSTA</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#fafafa;color:#262626;min-height:100vh;display:flex;flex-direction:column}
    .header{background:#fff;border-bottom:1px solid #dbdbdb;padding:16px 0;position:sticky;top:0;z-index:10;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .nav{max-width:935px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px}
    .back-btn{background:transparent;border:none;cursor:pointer;padding:8px;border-radius:50%}
    .back-btn:hover{background:#f5f5f5}
    .back-btn svg{width:24px;height:24px}
    .page-title{font-size:20px;font-weight:600}
    .spacer{width:40px}
    .main{flex:1;max-width:935px;margin:0 auto;padding:20px;width:100%}
    .search-card{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);border:1px solid #dbdbdb}
    .search-wrap{position:relative;max-width:500px;margin:0 auto}
    .search-input{width:100%;padding:14px 20px 14px 50px;border:1px solid #dbdbdb;border-radius:25px;background:#fafafa;font-size:14px}
    .search-input:focus{outline:none;border-color:#0095f6;background:#fff;box-shadow:0 0 10px rgba(0,149,246,.1)}
    .search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#8e8e8e}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);border:1px solid #dbdbdb;overflow:hidden}
    .card-h{padding:20px 24px;border-bottom:1px solid #dbdbdb;background:#fafafa}
    .title{font-size:16px;font-weight:600;margin-bottom:4px}
    .count{font-size:14px;color:#8e8e8e}
    .list{padding:0}
    .row{display:flex;align-items:center;padding:16px 24px;border-bottom:1px solid #efefef;gap:14px;cursor:pointer}
    .row:last-child{border-bottom:none}
    .row:hover{background:#fafafa}
    .ava{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #dbdbdb;flex-shrink:0}
    .info{flex:1;min-width:0}
    .uname{font-size:15px;font-weight:600}
    .dname{font-size:14px;color:#8e8e8e}
    .btn{border:none;border-radius:6px;padding:8px 14px;font-weight:600;cursor:pointer;transition:.2s}
    .btn-plain{background:transparent;border:1px solid #dbdbdb}
    .btn-plain:hover{background:#f5f5f5}
    .empty,.nores{text-align:center;padding:60px 24px;color:#8e8e8e}
    .empty svg{width:80px;height:80px;margin:0 auto 20px;opacity:.5}
    @media (max-width:768px){.main{padding:16px} .row{padding:12px 16px} .card-h{padding:16px 20px}}
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL="https://sdmlprsgxgrnzoqvgyqz.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWxwcnNneGdybnpvcXZneXF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDMyMDk4NiwiZXhwIjoyMDc1ODk2OTg2fQ.rWp3zL2V37X76_PdQAq-pw4uSzpOIyeQ9l3bjEC7tCM";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <header class="header">
    <nav class="nav">
      <button class="back-btn" onclick="location.href='homepage.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
      </button>
      <h1 class="page-title">Follower</h1>
      <div class="spacer"></div>
    </nav>
  </header>

  <main class="main">
    <section class="search-card">
      <div class="search-wrap">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input id="q" type="text" class="search-input" placeholder="Suche in deinen Followern…">
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="title">Follower</div>
        <div class="count" id="cnt">0 Personen</div>
      </div>
      <div class="list" id="list">
        <div class="empty" id="empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <h3 style="font-size:18px;font-weight:600;color:#262626;margin-bottom:8px">Noch keine Follower</h3>
          <p style="max-width:320px;margin:0 auto">Wenn dir jemand folgt, erscheint er hier.</p>
        </div>
        <div class="nores" id="nores" style="display:none">
          <h3 style="font-size:18px;font-weight:600;color:#262626;margin-bottom:8px">Keine Ergebnisse</h3>
          <p>Versuche einen anderen Suchbegriff.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    let CU = null;
    let followers = [];   // [{id, username, displayName, avatar}]
    let filtered  = [];

    const el = s => document.querySelector(s);
    const listEl = el('#list'), emptyEl = el('#empty'), noresEl = el('#nores'), cntEl = el('#cnt');

    function render(){
      listEl.querySelectorAll('.row').forEach(r => r.remove());

      const t = el('#q').value.trim();
      const arr = filtered;

      emptyEl.style.display = followers.length ? 'none' : 'block';
      noresEl.style.display  = (followers.length && t && arr.length===0) ? 'block' : 'none';

      arr.forEach(u=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <img class="ava" src="${u.avatar || 'assets/img/default-avatar.png'}" alt="${u.username}">
          <div class="info">
            <div class="uname">@${u.username}</div>
            <div class="dname">${u.displayName || ''}</div>
          </div>
          <button class="btn btn-plain" title="Zurück folgen">Folgen</button>
        `;
        // Profil öffnen
        row.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()==='button') return; window.location.href='profile.html?uid='+encodeURIComponent(u.id); });
        // Folge zurück
        row.querySelector('button').addEventListener('click', async (e)=>{
          e.stopPropagation();
          await followBack(u.id);
        });
        listEl.insertBefore(row, emptyEl);
      });

      const c = followers.length;
      cntEl.textContent = c === 1 ? '1 Person' : `${c} Personen`;
    }

    el('#q').addEventListener('input', () => {
      const t = el('#q').value.trim().toLowerCase();
      filtered = !t ? followers : followers.filter(u =>
        u.username.toLowerCase().includes(t) || (u.displayName||'').toLowerCase().includes(t)
      );
      render();
    });

    async function followBack(otherUserId){
      try{
        // eigenen Follow-Eintrag setzen: ich (CU) folge dem anderen
        const { error } = await sb.from('follows').insert({ follower_id: CU.id, following_id: otherUserId });
        if(error && !/duplicate/i.test(error.message)) throw error;
        // optional: UI-Feedback (z.B. Button ausgrauen) – hier simpel:
        alert('Gefolgt!');
      }catch(e){
        console.warn(e);
        alert('Konnte nicht folgen: '+(e.message||e));
      }
    }
    
    async function loadFollowersFromSupabase(uid){
    // Alle Relationen: Wer folgt MIR?
    const { data: rels, error: e1 } = await sb
      .from('follows')
      .select('follower_id')
      .eq('following_id', uid);

    if(e1){ console.warn(e1); return []; }

    // IDs deduplizieren (falls doch noch Duplikate existieren)
    const idSet = new Set((rels||[]).map(r => r.follower_id));
    const ids = [...idSet];
    if(ids.length === 0) return [];

    // Profile der Follower holen (nur die, die existieren)
    const { data: profs, error: e2 } = await sb
      .from('profiles')
      .select('id, username, display_name, avatar_url, avatar_path')
      .in('id', ids);

    if(e2){ console.warn(e2); }

    const byId = new Map((profs||[]).map(p => [p.id, p]));
    function publicUrl(path){ return sb.storage.from('images').getPublicUrl(path).data.publicUrl; }

    // Für jede ID ein User-Objekt bauen – auch wenn kein Profil vorhanden ist
    return ids.map(id => {
      const p = byId.get(id);
      const username = (p?.username?.trim()) || id.slice(0,8);
      const displayName = p?.display_name || '';
      const avatar = p?.avatar_url || (p?.avatar_path ? publicUrl(p.avatar_path) : 'assets/img/default-avatar.png');
      return { id, username, displayName, avatar };
    });
  }

    function setupRealtime(uid){
      try{
        sb.channel('followers-'+uid)
          .on('postgres_changes', { event:'*', schema:'public', table:'follows', filter:`following_id=eq.${uid}` }, async ()=>{
            followers = await loadFollowersFromSupabase(uid);
            filtered  = applyCurrentFilter(followers);
            render();
          })
          .subscribe();
      }catch(e){ console.warn('Realtime nicht aktiv?', e); }
    }

    function applyCurrentFilter(arr){
      const t = el('#q').value.trim().toLowerCase();
      if(!t) return arr;
      return arr.filter(u =>
        u.username.toLowerCase().includes(t) || (u.displayName||'').toLowerCase().includes(t)
      );
    }

    (async function init(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){ window.location.href='index.html'; return; }
      CU = user;

      followers = await loadFollowersFromSupabase(CU.id);
      filtered  = followers;
      render();
      setupRealtime(CU.id);
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil ansehen</title>
  <link rel="stylesheet" href="home-styles.css">
  <style>
    .wrap{max-width:900px;margin:80px auto 90px;padding:0 16px}
    .profile{display:grid;grid-template-columns:100px 1fr;gap:16px;align-items:center;background:#fff;border:1px solid #dbdbdb;border-radius:12px;padding:16px}
    .profile img{width:100px;height:100px;border-radius:50%;object-fit:cover}
    .u-main{display:flex;flex-direction:column;gap:8px}
    .uname{font-size:20px;font-weight:700}
    .name{color:#666}
    .stats{display:flex;gap:18px;color:#444}
    .stats b{margin-right:6px}
    .actions{display:flex;gap:10px;margin-top:6px}
    .btn{border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.follow{background:#0095f6;color:#fff}
    .btn.unfollow{background:#262626;color:#fff}
    .grid{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .tile{position:relative;border:1px solid #dbdbdb;border-radius:8px;overflow:hidden;background:#fff;cursor:pointer}
    .tile img{width:100%;height:180px;object-fit:cover;display:block}
    .empty{color:#8e8e8e;text-align:center;margin-top:30px}
    .back{position:fixed;top:14px;left:14px;background:#fff;border:1px solid #dbdbdb;border-radius:8px;padding:8px 12px;cursor:pointer;z-index:200}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL="https://sdmlprsgxgrnzoqvgyqz.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWxwcnNneGdybnpvcXZneXF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDMyMDk4NiwiZXhwIjoyMDc1ODk2OTg2fQ.rWp3zL2V37X76_PdQAq-pw4uSzpOIyeQ9l3bjEC7tCM";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    function publicUrl(path){ return sb.storage.from('images').getPublicUrl(path).data.publicUrl; }
  </script>
</head>
<body>
  <button class="back" onclick="history.back()">← Zurück</button>

  <header class="top-nav">
    <img class="nav-logo" src="https://i.ibb.co/Q7mG5wr3/Gibbsta-Logo-Haupt.png" alt="Gibbsta">
  </header>

  <main class="wrap">
    <section class="profile">
      <img id="avatar" src="assets/img/default-avatar.png" alt="Avatar" onerror="this.src='assets/img/default-avatar.png'">
      <div class="u-main">
        <div class="uname" id="uname">@user</div>
        <div class="name" id="dname"></div>
        <div class="stats">
          <div><b id="followers">0</b>Follower</div>
          <div><b id="following">0</b>Folgt</div>
          <div><b id="posts">0</b>Beiträge</div>
        </div>
        <div class="actions">
          <button class="btn follow" id="followBtn">Folgen</button>
          <button class="btn unfollow" id="unfollowBtn" style="display:none">Entfolgen</button>
        </div>
      </div>
    </section>

    <section class="grid" id="grid"></section>
    <p class="empty" id="empty" style="display:none">Dieser Nutzer hat noch keine Beiträge.</p>
  </main>

  <nav class="bottom-nav">
    <div class="nav-container">
      <button class="nav-item" onclick="location.href='home.html'">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='search.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="nav-item plus-btn" onclick="location.href='post.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="nav-item" onclick="location.href='homepage.html'">
        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="8" r="4"/><path d="M12 14c-4.5 0-8 2.5-8 5v1h16v-1c0-2.5-3.5-5-8-5z"/></svg>
      </button>
    </div>
  </nav>

  <script>
    const qs = new URLSearchParams(location.search);
    const UID = qs.get('uid'); // Profil des anderen Users
    let CU = null; // current user

    async function loadProfile(){
      CU = (await sb.auth.getUser()).data.user;
      if(!CU){ location.href='index.html'; return; }
      if(!UID){ document.getElementById('empty').textContent='Kein Benutzer angegeben.'; document.getElementById('empty').style.display='block'; return; }
      if(UID === CU.id){ location.href='homepage.html'; return; } // eigenes Profil → eigene Seite

      // Profil-Daten
      const { data: p, error: pErr } = await sb.from('profiles')
        .select('id,username,display_name,avatar_url,avatar_path')
        .eq('id', UID).maybeSingle();
      if(pErr || !p){ document.getElementById('empty').textContent='Benutzer nicht gefunden.'; document.getElementById('empty').style.display='block'; return; }

      const uname = p.username?.trim() ? p.username : (p.id ? p.id.slice(0,8) : 'user');
      document.getElementById('uname').textContent = '@'+uname;
      document.getElementById('dname').textContent = p.display_name || '';
      const av = p.avatar_url || (p.avatar_path ? publicUrl(p.avatar_path) : 'assets/img/default-avatar.png');
      document.getElementById('avatar').src = av;

      // Stats
      await refreshCounts();

      // Posts des Users
      const { data: posts, error: postErr } = await sb.from('posts')
        .select('id,image_path,created_at')
        .eq('user_id', UID)
        .order('created_at', {ascending:false});
      if(postErr){ console.warn(postErr); }

      const grid=document.getElementById('grid');
      grid.innerHTML='';
      const has = (posts && posts.length);
      document.getElementById('empty').style.display = has ? 'none' : 'block';
      if(has){
        posts.forEach(x=>{
          const img = publicUrl(x.image_path);
          grid.insertAdjacentHTML('beforeend',`
            <div class="tile" onclick="location.href='post.html?id=${encodeURIComponent(x.id)}'">
              <img src="${img}" alt="">
            </div>
          `);
        });
      }

      // Follow-Status
      await refreshFollowButtons();
      document.getElementById('followBtn').onclick = follow;
      document.getElementById('unfollowBtn').onclick = unfollow;
    }

    async function refreshCounts(){
      // follower count = Anzahl, die diesem Nutzer folgen
      const { count: followerCnt } = await sb
        .from('follows')
        .select('*', { count:'exact', head:true })
        .eq('following_id', UID);
      // following count = Anzahl, denen der Nutzer folgt
      const { count: followingCnt } = await sb
        .from('follows')
        .select('*', { count:'exact', head:true })
        .eq('follower_id', UID);
      // posts
      const { count: postsCnt } = await sb
        .from('posts')
        .select('*', { count:'exact', head:true })
        .eq('user_id', UID);
      document.getElementById('followers').textContent = followerCnt ?? 0;
      document.getElementById('following').textContent = followingCnt ?? 0;
      document.getElementById('posts').textContent = postsCnt ?? 0;
    }

    async function refreshFollowButtons(){
      const { data: rel } = await sb.from('follows')
        .select('id').eq('follower_id', CU.id).eq('following_id', UID).maybeSingle();
      const isFollowing = !!rel;
      document.getElementById('followBtn').style.display = isFollowing ? 'none' : 'inline-block';
      document.getElementById('unfollowBtn').style.display = isFollowing ? 'inline-block' : 'none';
    }

    async function follow(){
      const { error } = await sb.from('follows').insert({ follower_id: CU.id, following_id: UID });
      if(error && !/duplicate/i.test(error.message)) { alert('Folgen fehlgeschlagen: '+error.message); return; }
      await refreshFollowButtons();
      await refreshCounts(); // Zahl steigt direkt
    }

    async function unfollow(){
      const { error } = await sb.from('follows').delete().eq('follower_id', CU.id).eq('following_id', UID);
      if(error){ alert('Entfolgen fehlgeschlagen: '+error.message); return; }
      await refreshFollowButtons();
      await refreshCounts();
    }

    loadProfile();
  </script>
</body>
</html>
